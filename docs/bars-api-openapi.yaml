openapi: 3.0.3
info:
  title: To The Pub - Bars API
  description: |
    Comprehensive API for managing and retrieving bar data with optional related information.
    
    ## Authentication
    Protected endpoints require a JWT token in the Authorization header:
    `Authorization: Bearer <your-jwt-token>`
    
    ## Optional Include Parameter
    Most GET endpoints support an `include` query parameter to fetch related data:
    - `hours` - Operating hours for each day
    - `tags` - Tags/categories associated with the bar  
    - `events` - Upcoming events at the bar
  version: 1.0.0
  contact:
    name: To The Pub API Support
    url: https://github.com/Jackspence49/to-the-pub-backend
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.tothepub.com/api
    description: Production server

paths:
  /bars:
    get:
      summary: Get all bars with optional filtering
      description: Retrieve a list of all active bars with optional filtering and related data
      tags:
        - Bars (Public)
      parameters:
        - $ref: '#/components/parameters/IncludeParam'
        - name: tag
          in: query
          description: Filter by tag name (case-insensitive)
          schema:
            type: string
          example: "Sports Bar"
        - name: city
          in: query
          description: Filter by city (case-insensitive)
          schema:
            type: string
          example: "boston"
        - name: open_now
          in: query
          description: Filter by bars currently open
          schema:
            type: boolean
          example: true
        - name: has_events
          in: query
          description: Filter by bars with upcoming events
          schema:
            type: boolean
          example: true
        - name: page
          in: query
          description: Page number for pagination
          schema:
            type: integer
            minimum: 1
            default: 1
          example: 1
        - name: limit
          in: query
          description: Maximum number of results per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          example: 20
      responses:
        '200':
          description: Successfully retrieved bars
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BarsListResponse'
        '500':
          $ref: '#/components/responses/ServerError'
    
    post:
      summary: Create a new bar
      description: Create a new bar with hours and tags (requires authentication)
      tags:
        - Bars (Protected)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBarRequest'
      responses:
        '201':
          description: Bar created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBarResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/ServerError'

  /bars/{id}:
    get:
      summary: Get a single bar
      description: Retrieve a single bar by ID with optional related data
      tags:
        - Bars (Public)
      parameters:
        - $ref: '#/components/parameters/BarIdParam'
        - $ref: '#/components/parameters/IncludeParam'
      responses:
        '200':
          description: Successfully retrieved bar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BarResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'
    
    put:
      summary: Update an existing bar
      description: Update bar information (requires authentication)
      tags:
        - Bars (Protected)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BarIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBarRequest'
      responses:
        '200':
          description: Bar updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateBarResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/ServerError'
    
    delete:
      summary: Delete a bar (soft delete)
      description: Soft delete a bar by setting is_active to false (requires authentication)
      tags:
        - Bars (Protected)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BarIdParam'
      responses:
        '200':
          description: Bar deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteBarResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/ServerError'

  /bars/search/name:
    get:
      summary: Search bars by name
      description: Search for bars by name with optional related data
      tags:
        - Bars (Public)
      parameters:
        - name: q
          in: query
          required: true
          description: Search query for bar name
          schema:
            type: string
            minLength: 1
          example: "irish"
        - $ref: '#/components/parameters/IncludeParam'
      responses:
        '200':
          description: Successfully retrieved search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchBarsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    BarIdParam:
      name: id
      in: path
      required: true
      description: Unique identifier for the bar
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    IncludeParam:
      name: include
      in: query
      description: Comma-separated list of related data to include
      schema:
        type: string
        pattern: '^(hours|tags|events)(,(hours|tags|events))*$'
      example: "hours,tags"

  schemas:
    Bar:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the bar
        name:
          type: string
          description: Name of the bar
        description:
          type: string
          nullable: true
          description: Description of the bar
        address_street:
          type: string
          description: Street address
        address_city:
          type: string
          description: City
        address_state:
          type: string
          description: State/Province
        address_zip:
          type: string
          description: ZIP/Postal code
        latitude:
          type: number
          format: float
          nullable: true
          description: Latitude coordinate
        longitude:
          type: number
          format: float
          nullable: true
          description: Longitude coordinate
        phone:
          type: string
          nullable: true
          description: Phone number
        website:
          type: string
          format: uri
          nullable: true
          description: Website URL
        instagram:
          type: string
          nullable: true
          description: Instagram handle
        facebook:
          type: string
          nullable: true
          description: Facebook page name
        is_active:
          type: integer
          enum: [0, 1]
          description: Whether the bar is active (1) or deleted (0)
        created_at:
          type: string
          format: date-time
          description: Creation timestamp
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp
        hours:
          type: array
          items:
            $ref: '#/components/schemas/BarHours'
          description: Operating hours (included when include=hours)
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: Associated tags (included when include=tags)
        upcoming_events:
          type: array
          items:
            $ref: '#/components/schemas/Event'
          description: Upcoming events (included when include=events)

    BarHours:
      type: object
      properties:
        day_of_week:
          type: integer
          minimum: 0
          maximum: 6
          description: Day of week (0=Sunday, 1=Monday, ..., 6=Saturday)
        open_time:
          type: string
          format: time
          nullable: true
          description: Opening time in HH:MM:SS format
          example: "12:00:00"
        close_time:
          type: string
          format: time
          nullable: true
          description: Closing time in HH:MM:SS format
          example: "23:00:00"
        is_closed:
          type: boolean
          description: Whether the bar is closed all day

    Tag:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the tag
        name:
          type: string
          description: Tag name
        category:
          type: string
          nullable: true
          enum: [type, atmosphere, amenity]
          description: Tag category

    Event:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the event
        name:
          type: string
          description: Event name
        event_date:
          type: string
          format: date
          description: Event date in YYYY-MM-DD format
        start_time:
          type: string
          format: time
          nullable: true
          description: Event start time in HH:MM:SS format
        event_type:
          type: string
          nullable: true
          description: Type of event

    CreateBarRequest:
      type: object
      required:
        - name
        - address_street
        - address_city
        - address_state
        - address_zip
      properties:
        name:
          type: string
          description: Name of the bar
        description:
          type: string
          nullable: true
          description: Description of the bar
        address_street:
          type: string
          description: Street address
        address_city:
          type: string
          description: City
        address_state:
          type: string
          description: State/Province
        address_zip:
          type: string
          description: ZIP/Postal code
        latitude:
          type: number
          format: float
          nullable: true
          description: Latitude coordinate
        longitude:
          type: number
          format: float
          nullable: true
          description: Longitude coordinate
        phone:
          type: string
          nullable: true
          description: Phone number
        website:
          type: string
          format: uri
          nullable: true
          description: Website URL
        instagram:
          type: string
          nullable: true
          description: Instagram handle
        facebook:
          type: string
          nullable: true
          description: Facebook page name
        hours:
          type: array
          items:
            $ref: '#/components/schemas/BarHours'
          description: Operating hours
        tag_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Array of existing tag IDs to associate with the bar

    UpdateBarRequest:
      type: object
      description: All fields are optional. Only provided fields will be updated.
      properties:
        name:
          type: string
          description: Name of the bar
        description:
          type: string
          nullable: true
          description: Description of the bar
        address_street:
          type: string
          description: Street address
        address_city:
          type: string
          description: City
        address_state:
          type: string
          description: State/Province
        address_zip:
          type: string
          description: ZIP/Postal code
        latitude:
          type: number
          format: float
          nullable: true
          description: Latitude coordinate
        longitude:
          type: number
          format: float
          nullable: true
          description: Longitude coordinate
        phone:
          type: string
          nullable: true
          description: Phone number
        website:
          type: string
          format: uri
          nullable: true
          description: Website URL
        instagram:
          type: string
          nullable: true
          description: Instagram handle
        facebook:
          type: string
          nullable: true
          description: Facebook page name
        hours:
          type: array
          items:
            $ref: '#/components/schemas/BarHours'
          description: Operating hours (completely replaces existing hours)
        tag_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Array of tag IDs (completely replaces existing tag relationships)

    BarsListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Bar'
        meta:
          type: object
          properties:
            count:
              type: integer
              description: Number of bars returned
            page:
              type: integer
              description: Current page number
            limit:
              type: integer
              description: Number of results per page
            filters:
              type: object
              description: Filters applied to the query
              properties:
                tag:
                  type: string
                  nullable: true
                city:
                  type: string
                  nullable: true
                open_now:
                  type: string
                  nullable: true
                has_events:
                  type: string
                  nullable: true
            included:
              type: array
              items:
                type: string
              description: List of included related data

    BarResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Bar'
        meta:
          type: object
          properties:
            included:
              type: array
              items:
                type: string
              description: List of included related data

    SearchBarsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: array
          items:
            $ref: '#/components/schemas/Bar'
        meta:
          type: object
          properties:
            query:
              type: string
              description: The search query used
            count:
              type: integer
              description: Number of results found
            included:
              type: array
              items:
                type: string
              description: List of included related data

    CreateBarResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              description: ID of the created bar

    UpdateBarResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Bar updated successfully"
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              description: ID of the updated bar

    DeleteBarResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Bar deleted successfully"
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              description: ID of the deleted bar

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message

    AuthErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          description: Error message

  responses:
    BadRequest:
      description: Bad request - missing required parameters or validation errors
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Missing required bar fields"

    Unauthorized:
      description: No authentication token provided
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthErrorResponse'
          example:
            success: false
            message: "Access denied. No token provided or invalid format. Expected: Bearer <token>"

    Forbidden:
      description: Invalid or expired authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthErrorResponse'
          example:
            success: false
            message: "Invalid token"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Bar not found"

    Conflict:
      description: Resource conflict (e.g., duplicate bar)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "A bar with this name and address already exists"

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Failed to fetch bars"

tags:
  - name: Bars (Public)
    description: Public endpoints for retrieving bar data (no authentication required)
  - name: Bars (Protected)
    description: Protected endpoints for managing bars (authentication required)